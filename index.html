<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf8">
        <title>Flight Delays</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="">
        <style>
            #map { width: 1100px; height: 550px; }
        </style>
    </head>
    <body>
        <div id="map"></div>

        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
        <script>
let baseLayer = new L.tileLayer('https://a.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
    id: 'mapbox.world-dark',
    maxZoom: 20,
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>'
})

let map = new L.map('map', {
    center: new L.LatLng(37.8, -96),
    zoom: 4,
    layers: [baseLayer]
})

let shadowUrl = 'https://unpkg.com/leaflet@1.2.0/dist/images/marker-shadow.png';
let delayCategories = ['none', 'low', 'medium', 'high', 'extreme']
let trafficScales = [0.2, 0.4, 0.6, 0.8, 1]
let trafficLimits = [50, 100, 200, 5000]
let delayLimits = [15, 30, 45, 60]
let deficon = new L.Icon.Default()
let scale = (s, arr) => arr.map((x) => s * x)

let icons = delayCategories.map((del, del_id) =>
    trafficScales.map((traf, traf_id) =>
        L.icon({
            iconUrl: 'marker-' + del + '.svg',
            shadowUrl: shadowUrl,

            iconSize: scale(traf, deficon.options.iconSize),
            shadowSize: scale(traf, deficon.options.shadowSize),
            iconAnchor: scale(traf, deficon.options.iconAnchor),
            //shadowAnchor: scale(traf, deficon.options.shadowAnchor),
            popupAnchor: scale(traf, deficon.options.popupAnchor),
        })
    )
)

d3.csv('airports-delay.csv', (data) => {
    data.forEach((airport) => {
        L.marker([airport.Lat, airport.Lng], {
            icon: airportIcon(airport),
            title: airport.Origin,
        }).addTo(map)
    })
})

function airportIcon(airport) {
    let traffic = 0
    for (traffic = 0; traffic < trafficLimits.length; traffic++)
        if (airport.Flights < trafficLimits[traffic])
            break

    let delay = 0
    for (delay = 0; delay < delayLimits.length; delay++)
        if (airport.DepDelay < delayLimits[delay])
            break

    return icons[delay][traffic]
}
        </script>
        <a href="sankey.html">See airport visual</a>
    </body>
</html>
